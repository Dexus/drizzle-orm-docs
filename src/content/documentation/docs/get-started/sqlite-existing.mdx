import Npm from '@components/markdown/Npm.astro';
import Callout from '@components/markdown/Callout.astro';
import Prerequisites from "@mdx/Prerequisites.astro";
import CodeTabs from "@mdx/CodeTabs.astro";
import WhatsNextPostgres from "@mdx/WhatsNextPostgres.astro";
import Breadcrumbs from '@components/markdown/Breadcrumbs.astro';

<Breadcrumbs/>

# Get Started with Drizzle and SQLite in existing project

<Prerequisites>  
  - You should have installed Drizzle ORM and [Drizzle kit](https://orm.drizzle.team/kit-docs/overview). You can do this by running the following command:
  <Npm>
    drizzle-orm 
    -D drizzle-kit
  </Npm>
  - You should have installed `dotenv` package for managing environment variables. Read more about this package [here](https://www.npmjs.com/package/dotenv)
  <Npm>
    dotenv
  </Npm>
</Prerequisites>

#### Basic file structure

This is the basic file structure of the project. In the `src/db` directory, we have database-related files including connection in `index.ts` and table definition in `schema.ts`. In `drizzle` folder there are sql migration file and snapshots.

```plaintext
ðŸ“¦ <project root>
 â”œ ðŸ“‚ drizzle
 â”œ ðŸ“‚ src
 â”‚   â”œ ðŸ“‚ db
 â”‚   â”‚  â”” ðŸ“œ schema.ts
 â”‚   â”” ðŸ“œ index.ts
 â”œ ðŸ“œ .env
 â”œ ðŸ“œ drizzle.config.ts
 â”œ ðŸ“œ package.json
 â”” ðŸ“œ tsconfig.json
```

#### Step 1 - Install the `@libsql/client` package

<Npm>
@libsql/client
</Npm>

#### Step 2 - Setup connection variables

Create a `.env` file in the root of your project and add you SQLite file connection string:

```plaintext copy
DB_FILE_NAME=
```

<Callout type='info' title='important'>
For example, if you want to create an SQLite database file in the root of your project for testing purposes, you need to use `file:` before the actual filename, as this is the format required by `LibSQL`, like this:
```plaintext copy
DB_FILE_NAME=file:local.db
```
You can check the **[LibSQL docs](https://docs.turso.tech/sdk/ts/reference#local-development)** for more info.
</Callout>

#### Step 3 - Setup Drizzle config file

**Drizzle config** - a configuration file that is used by [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview) and contains all the information about your database connection, migration folder and schema files.

Create a `drizzle.config.ts` file in the root of your project and add the following content:

```typescript copy filename="drizzle.config.ts"
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './src/db/schema.ts',
  dialect: 'sqlite',
  dbCredentials: {
    url: process.env.DB_FILE_NAME!,
  },
});
```

#### Step 4 - Introspect your database

Drizzle Kit provides a CLI command to introspect your database and generate a schema file with migrations. The schema file contains all the information about your database tables, columns, relations, and indices.

For example, you have such table in your database:

```sql copy
CREATE TABLE `users_table` (
	`id` integer PRIMARY KEY AUTOINCREMENT NOT NULL,
	`name` text NOT NULL,
	`age` integer NOT NULL,
	`email` text NOT NULL UNIQUE
);
```

Pull your database schema:

```bash copy
npx drizzle-kit pull
```

The result of introspection will be a `schema.ts` file, `meta` folder with snapshots of your database schema, sql file with the migration and `relations.ts` file for [relational queries](/docs/rqb).

Here is an example of the generated `schema.ts` file:

```typescript copy filename="drizzle/schema.ts"
// table schema generated by introspection
import {
  sqliteTable,
  uniqueIndex,
  integer,
  text,
} from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable(
  "users_table",
  {
    id: integer().primaryKey({ autoIncrement: true }).notNull(),
    name: text().notNull(),
    age: integer().notNull(),
    email: text().notNull(),
  },
  (table) => {
    return {
      emailUnique: uniqueIndex("users_table_email_unique").on(table.email),
    };
  }
);
```

Learn more about introspection in the [documentation](/kit-docs/commands#introspect--pull).

#### Step 5 - Transfer code to your actual schema file

We recommend transferring the generated code from `drizzle/schema.ts` and `drizzle/relations.ts` to the actual schema file. In this guide we transferred code to `src/db/schema.ts`. Generated files for schema and relations can be deleted. This way you can manage your schema in a more structured way.

<Callout type="warning">
If you decided to continue working with generated `drizzle/schema.ts` file then you should update your `drizzle.config.ts` with proper schema path.

```typescript copy filename="drizzle.config.ts" {6}
import 'dotenv/config';
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  out: './drizzle',
  schema: './drizzle/schema.ts',
  dialect: 'sqlite',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
});
```
</Callout>

#### Step 6 - Connect Drizzle ORM to the database

Create a `index.ts` file in the `src` directory and initialize the connection:

<CodeTabs items={["libsql", "libsql with config", "turso alias"]}>
```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm';

async function main() {
  const db = await drizzle("libsql", process.env.DB_FILE_NAME!);
}

main();
```
```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm';

async function main() {
  // You can specify any property from the libsql connection options
  const db = await drizzle("libsql", { connection: { url: process.env.DB_FILE_NAME! }});
}

main();
```
```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm';

async function main() {
  // You can specify any property from the libsql connection options
  const db = await drizzle("turso", { connection: { url: DB_FILE_NAME! }});
}

main();
```
</CodeTabs>

If you need a synchronous connection, you can use our additional connection API, 
where you specify a driver connection and pass it to the Drizzle instance.

```typescript copy
import 'dotenv/config';
import { drizzle } from 'drizzle-orm/libsql';
import { createClient } from '@libsql/client';

async function main() {
  const client = createClient({ url: DB_FILE_NAME! });
  const db = drizzle(client);
}

main();
```

# Step 7 - Query the database

In `src/index.ts` file you can perform CRUD operations:

<Callout type="warning">
If you decided to continue working with generated `drizzle/schema.ts` file and you've updated your `drizzle.config.ts` with proper schema path, please use **schema in drizzle folder** tab
</Callout>

<CodeTabs items={['schema in "src" folder', 'schema in "drizzle" folder']}>
```typescript copy filename="src/index.ts" {8-37}
import 'dotenv/config';
import { drizzle, eq } from 'drizzle-orm';
import { usersTable } from './db/schema';

async function main() {
  const db = await drizzle("libsql", process.env.DB_FILE_NAME!);

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('New user created!')

  const users = await db.select().from(usersTable);
  console.log('Getting all users from the database: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('User info updated!')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('User deleted!')
}

main();
```
```typescript copy filename="src/index.ts" {8-37}
import 'dotenv/config';
import { drizzle, eq } from 'drizzle-orm';
import { usersTable } from '../drizzle/schema';

async function main() {
  const db = await drizzle("libsql", process.env.DB_FILE_NAME!);

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
  };

  await db.insert(usersTable).values(user);
  console.log('New user created!')

  const users = await db.select().from(usersTable);
  console.log('Getting all users from the database: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('User info updated!')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('User deleted!')
}

main();
```
</CodeTabs>

#### Step 8 - Run index.ts file

To run any TypeScript files, you have several options, but let's stick with one: using `tsx`

**Install `tsx`**
<CodeTabs items={['npm', 'yarn', 'pnpm']}>
```bash copy
npm i -D tsx
```
```bash copy
yarn add -D tsx
```
```bash copy
pnpm add -D tsx
```
</CodeTabs>

**Run `index.ts` script**
<CodeTabs items={['npm', 'yarn', 'pnpm']}>
```bash copy
npm tsx src/index.ts
```
```bash copy
yarn tsx src/index.ts
```
```bash copy
pnpm tsx src/index.ts
```
</CodeTabs>

<Callout title='tips'>
  We suggest using `bun` to run TypeScript files. With `bun`, such scripts can be executed without issues or additional 
  settings, regardless of whether your project is configured with CommonJS (CJS), ECMAScript Modules (ESM), or any other module format. 
  To run a script with `bun`, use the following command:
  ```bash copy
  bun src/index.ts
  ```

  If you don't have bun installed, check the [Bun installation docs](https://bun.sh/docs/installation#installing)
</Callout>

#### Step 9 - Update your table schema (optional)

If you want to update your table schema, you can do it in the `schema.ts` file. For example, let's add a new column `phone` to the `users_table`:

```typescript copy filename="src/db/schema.ts" {16}
// table schema generated by introspection
import {
  sqliteTable,
  uniqueIndex,
  integer,
  text,
} from "drizzle-orm/sqlite-core";

export const usersTable = sqliteTable(
  "users_table",
  {
    id: integer().primaryKey({ autoIncrement: true }).notNull(),
    name: text().notNull(),
    age: integer().notNull(),
    email: text().notNull(),
    phone: text(),
  },
  (table) => {
    return {
      emailUnique: uniqueIndex("users_table_email_unique").on(table.email),
    };
  }
);
```

#### Step 9 - Applying changes to the database (optional)

You can generate migrations using `drizzle-kit generate` command and then apply them using the `drizzle-kit migrate` command.
Learn more about migration process in [documentation](/kit-docs/overview#schema-updates).

Generate migrations:

```bash copy
npx drizzle-kit generate
```

Apply migrations:

```bash copy
npx drizzle-kit migrate
```

<Callout type="warning">
Alternatively, you can push changes directly to the database using [Drizzle kit push command](/kit-docs/overview#prototyping-with-db-push):

```bash copy
npx drizzle-kit push
```

Push command is good for situations where you need to quickly test new schema designs or changes in a local development environment, allowing for fast iterations without the overhead of managing migration files.
</Callout>


#### Step 10 - Query the database with a new field (optional)

<Callout type="warning">
If you decided to continue working with generated `drizzle/schema.ts` file and you've updated your `drizzle.config.ts` with proper schema path, please use **schema in drizzle folder** tab
</Callout>

<CodeTabs items={['schema in "src" folder', 'schema in "drizzle" folder']}>
```typescript copy filename="src/index.ts" {12, 26}
import 'dotenv/config';
import { drizzle, eq } from 'drizzle-orm';
import { usersTable } from './db/schema';

async function main() {
  const db = await drizzle("libsql", process.env.DB_FILE_NAME!);

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('New user created!')

  const users = await db.select().from(usersTable);
  console.log('Getting all users from the database: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('User info updated!')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('User deleted!')
}

main();
```
```typescript copy filename="src/index.ts" {12, 26}
import 'dotenv/config';
import { drizzle, eq } from 'drizzle-orm';
import { usersTable } from '../drizzle/schema';

async function main() {
  const db = await drizzle("libsql", process.env.DB_FILE_NAME!);

  const user: typeof usersTable.$inferInsert = {
    name: 'John',
    age: 30,
    email: 'john@example.com',
    phone: '123-456-7890',
  };

  await db.insert(usersTable).values(user);
  console.log('New user created!')

  const users = await db.select().from(usersTable);
  console.log('Getting all users from the database: ', users)
  /*
  const users: {
    id: number;
    name: string;
    age: number;
    email: string;
    phone: string | null;
  }[]
  */

  await db
    .update(usersTable)
    .set({
      age: 31,
    })
    .where(eq(usersTable.email, user.email));
  console.log('User info updated!')

  await db.delete(usersTable).where(eq(usersTable.email, user.email));
  console.log('User deleted!')
}

main();
```
</CodeTabs>